name: Publish

on:
  push:
    tags:
      - '*'

jobs:
  # create-release:
  #   name: Create release
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: write
  #     discussions: write # (for release discussion creation)
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Publish release
  #       uses: ghalactic/github-release-from-tag@v5

  publish-releases:
    # needs: create-release
    name: Publish binaries
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target: [linux-arm64, linux-x64, windows-x64, darwin-arm64, darwin-x64]

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - name: Build
        run: |
          bun build src/index.ts --compile --target=bun-${{ matrix.target }} --outfile out/gg-${{ matrix.target }}

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: out/gg-${{ matrix.target }}
          asset_name: ${{ matrix.target }}
          tag: ${{ github.ref }}
          overwrite: true
          body: "Binary release for ${{ matrix.target }}"